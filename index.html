<!DOCTYPE html>
<html>
<head>
  <title>Onchain Message</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</head>
<body>
  <h1>Send Onchain Message</h1>
  <textarea id="message" placeholder="Type your message"></textarea><br><br>
  <button id="sendBtn">Send Message</button>

  <script>
    let web3;
    let contract;
    let userAccount;

    const contractAddress = '0xbF2B459a4F332a52347648C21cA42A46F505C050';
    const abi = [ 
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "message",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "MessageSent",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "message",
				"type": "string"
			}
		],
		"name": "sendMessage",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
 ];

    window.addEventListener('load', async () => {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          const accounts = await web3.eth.getAccounts();
          userAccount = accounts[0];

          contract = new web3.eth.Contract(abi, contractAddress);

          document.getElementById("sendBtn").addEventListener("click", async () => {
            const message = document.getElementById("message").value;
            if (!message) return alert("Please type a message.");
            try {
              await contract.methods.sendMessage(message).send({ from: userAccount });
              alert("Message sent!");
            } catch (err) {
              console.error(err);
              alert("Transaction failed.");
            }
          });

        } catch (error) {
          console.error("User denied account access", error);
        }
      } else {
        alert("Please install MetaMask!");
      }
    });
  </script>
</body>
</html>
